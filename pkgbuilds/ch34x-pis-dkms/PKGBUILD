# Maintainer: Your Name <you@example.com>
pkgname=ch34x-pis-dkms
pkgver=1.0
pkgrel=1
pkgdesc="WCH CH34x PiS kernel module (DKMS) and libch347 user library"
arch=('x86_64' 'aarch64' 'armv7h')
url="https://www.wch.cn"
license=('GPL')
depends=('dkms')
makedepends=()
install=ch34x-pis.install
source=("CH341PAR_LINUX.zip::https://www.wch.cn/download/file?id=202")
sha256sums=('13bb7ca831d640bb249213744eabeb402ddde79cb62b87a0d78d6e03614ef76e')

prepare() {
    :
}

build() {
    :
}

package() {
    cd "$srcdir"

    driver_src="${srcdir}/CH341PAR_LINUX/driver"
    if [ ! -d "${driver_src}" ]; then
        echo "ERROR: driver source directory not found under ${driver_src}"
        return 1
    fi

    # 1) 安装 DKMS 源目录到 /usr/src/ch34x_pis-<ver>
    dst="/usr/src/ch34x_pis-${pkgver}"
    install -dm755 "${pkgdir}${dst}"
    cp -a "${driver_src}/ch34x_pis.c" "${pkgdir}${dst}/"

    # 2) 在 /usr/src/... 下写入 dkms.conf 和 makefile
    install -Dm644 /dev/stdin "${pkgdir}${dst}/Makefile" <<'EOF'
obj-m := ch34x_pis.o
EOF
    install -Dm644 /dev/stdin "${pkgdir}${dst}/dkms.conf" <<'EOF'
PACKAGE_NAME="ch34x_pis"
PACKAGE_VERSION="1.0"
BUILT_MODULE_NAME[0]="ch34x_pis"
DEST_MODULE_LOCATION[0]="/kernel/drivers/usb/misc"
AUTOINSTALL="yes"

MAKE[0]="
  echo '==> Building ch34x_pis.ko for kernel ${kernelver}' &&
  mkdir -p ${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build &&
  cp -f ${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/source/ch34x_pis.c \
        ${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build/ &&
  make -C /lib/modules/${kernelver}/build M=${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build modules
"

EOF

    # 3) 安装 libch347.so（按架构选择合适的库）
    case "${CARCH}" in
        x86_64)
            libpath="${srcdir}/CH341PAR_LINUX/lib/x64/dynamic/libch347.so"
            ;;
        aarch64)
            libpath="${srcdir}/CH341PAR_LINUX/lib/aarch64/dynamic/libch347.so"
            ;;
        armv7h)
            libpath="${srcdir}/CH341PAR_LINUX/lib/arm-gnueabihf/dynamic/libch347.so"
            ;;
        *)
            libpath="${srcdir}/CH341PAR_LINUX/lib/x64/dynamic/libch347.so"
            ;;
    esac

    if [ -f "${libpath}" ]; then
        install -Dm755 "${libpath}" "${pkgdir}/usr/lib/libch347.so"
    else
        echo "WARNING: libch347.so not found for arch ${CARCH} at ${libpath}; skipping."
    fi

    # 4) 安装 udev 规则（匹配 ch34x_pis* 设备）
    install -Dm644 /dev/stdin "${pkgdir}/usr/lib/udev/rules.d/99-ch34x.rules" <<'EOF'
# WCH ch34x pis device nodes
KERNEL=="ch34x_pis*", MODE="0660", GROUP="ch34x"
EOF

    # 5) 使用 sysusers.d 自动创建 ch34x 组（更官方）
    install -Dm644 /dev/stdin "${pkgdir}/usr/lib/sysusers.d/ch34x.conf" <<'EOF'
# create group ch34x
g ch34x - -
EOF

}
