# Android Setup

由于安卓设备基于Linux内核，本质上是一个提供特定的Java运行时环境、IPC服务、更加严苛的权限管理模型、特定的用户态驱动模型的Linux发行版，因此在特定条件下，可以将安卓设备转换为Linux设备，运行Linux应用。然而，安卓本身的特性导致这样的使用方法受到诸多限制：

- 安卓设备使用的芯片（联发科、高通）所带有的GPU芯片提供的用户空间驱动（OpenGL、Vulkan）支持不足
- 安卓默认的图形服务SurfaceFlinger抢占了内核的DRM/KMS接口，无法共用
- 安卓默认的音频服务抢占了内核的ALSA接口，无法共用
- 安卓的其余系统服务与桌面Linux环境差别较大

解决方法如下：

- 针对多数的用户空间系统服务而言，使用容器/虚拟机技术来隔离安卓和Linux环境，单独安装Linux所需的用户空间服务；
- 针对图形服务，使用VNC/Termux:X11作为安卓客户端，将隔离的Linux环境的图形转发并显示，但这就代表无法运行Wayland应用；
- 针对音频服务，使用pulse audio音频转发接入安卓音频服务，针对专业音频则使用外接声卡穿透并应用jack2；

在实现这些功能的过程中，根据安卓的本身的特性，有许多不同的方案：

1. 虚拟机方案：
    - 由于安卓设备SoC广泛设计原因，Linux内核支持的KVM本身是无法运行的，但是随着安卓13以来AVF的广泛推进，已经有了pKVM模式的虚拟机系统，可以运行虚拟机
2. 容器方案：
    - lxc容器，仅仅在安卓系统本身获取了系统的root权限之后才可以使用，并且可以选择是否给lxc容器中的应用root权限；
    - chroot,也需要安卓设备获取root权限
    - proot,不需要获取root权限，将一个安卓软件目录下的某个地址作为proot系统的根目录

对于安卓机器而言，获取了安卓的root权限后可以进行的细粒度管理与各种系统服务的hook和屏蔽较为重要。在获取root权限前，需要先解锁设备的bootloader锁，才能进行相关操作。这两步的难易程度与设备厂商的风格息息相关。由于目标是实现linux系统较为完善的功能，并且对于安卓机器有着较为清晰的控制手段和精度，同时保证两者之间无缝衔接，因此选用rooted lxc容器的技术，配备现有的安卓芯片GPU硬件加速驱动提供的图形API以及硬件解码API，使用pulse audio音频转发，将linux环境的GUI显示在termux:x11界面上。同时，可以使用root权限对安卓端的权限管理、UI逻辑进行多种定制，配合安卓上的root工具一并打造安卓+linux双环境的通用设备。

## 配置步骤

- 使用一加品牌的设备方便root，多次点击版本号打开开发者模式，打开停止限制子进程选项，解锁对于安卓应用子进程数量的限制
- 安卓上安装f-droid、google play商店作为包管理器
- 安装nekobox作为网络代理，开放电池管理与后台自启动最大权限
- 安装fennec浏览器，多次点击版本号进入开发者模式，使用firefox插件网站安装所需的插件
- 从f-droid上安装termux系列app，从github安装termux:x11
- 使用bitwarden作为密码管理器
- 使用vlc作为视频播放器
- 使用fcitx5小企鹅输入法

## drafts

### 学习资源

- termux
- magisk
- kernelSU

### 路径

- 先不考虑GUI
- 在安卓设备上实现一个自建的特权容器，chroot+namespace+cgroup方式脱离安卓系统的管理并且获得SELinux下的高级权限
